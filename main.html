<!DOCTYPE html>
<html>
  <title>SSX2020PE™</title>
  <head>
    <link rel="stylesheet" href="main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

  <body>
    <div id="navbar">
      <h2>SSX2020PE™</h2>
      <div id="navmenu">
        <a href="">About</a>
        <span>|</span>
        <a href="">Account</a>
        <span>|</span>
        <a href="">Help</a>
        <span>|</span>
        <a href="">Logout</a>
      </div>
    </div>

    <div id="graphic">
    </div>

    <div id="menu">
      <h1 id="current_ticker">$AAPL</h1>
      <h4 id="current_stock">Apple Inc</h4>
      <hr style="border: 1.5px solid white">
      <p id="current_holdings">Current holdings: <span id="num_shares">0</span> shares</p>
      <p id="shares_value">Total value of shares: $<span id="shares_dollars">0</span></p>
      <form id="buy_sell">
        <input type="radio" id="buy" name="buy_or_sell" value="buy" checked>
        <label for="buy">Buy</label>
        <input type="radio" id="sell" name="buy_or_sell" value="sell">
        <label for="sell">Sell</label>
        <input id="buy_sell_shares" type="number">
        <span> shares<button type="button" id="confirm_sale" onclick="confirmSale()">Confirm</button></span>
      </form>
      <hr style="border: 1.5px solid white">
      <div id="enter_ticker">Enter a new stock symbol: <input id="new_ticker"><button type="button" id="search_ticker" onclick="updateAll()">Search</button></div>

      <hr style="border: 1.5px solid white">
    </div>

    <div id="holdings">
      <div id="stats_time">
        <p>Current date: <span id="current_date"></span></p>
        <p>Days remaining: <span id="days_remaining"></span></p>
        <p>24hr change: <span id="24hr_change_percent">0</span>%/$<span id="24hr_change_dollars">0</span></p>
        <p>Overall change: <span id="total_change_percent">0</span>%/$<span id="total_change_dollars">0</span></p>
        <button id="advance_date" type="button" onclick="advanceDate()">Advance day</button>
      </div>
      <div id="stats_cash">
        <p>Cash available: $<span id="cash_available">0</span></p>
        <p>Portfolio value: $<span id="portfolio_value">0</span></p>
        <p>Total assets: $<span id="total_assets">0</span></p>
      </div>
      <div id="stats_holdings">
        <table id="holdings_table">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Shares</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>AMZN</td>
              <td>5</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      const apiKey = "SK92GYM09TPNS82E";
      var date = new Date();
      date.setDate(date.getDate() - 365);
      var daysRemaining = 365;
      var cashAvailable = 5000;
      var portfolioValue = 0;
      var currentTicker = "AAPL";
      var validDates;
      var userStocks = {};
      getValidDates();

      initialLoad();

      async function initialLoad() {
        if (await updateTicker("AAPL")) {
          updateGraph("AAPL");
        }
        document.getElementById("current_date").innerHTML = date.toLocaleDateString();
        document.getElementById("days_remaining").innerHTML = daysRemaining;
        document.getElementById("cash_available").innerHTML = cashAvailable;
        document.getElementById("portfolio_value").innerHTML = portfolioValue;
        document.getElementById("total_assets").innerHTML = cashAvailable + portfolioValue;
      }

      async function getValidDates() {
        const url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=AAPL&outputsize=full&apikey=" + apiKey;
        const dates = await fetch(url)
        .then(response => response.json())
        .then(data => data["Time Series (Daily)"]);
        validDates = dates;
      }

      function advanceDate() {
        date.setDate(date.getDate() + 1);
        daysRemaining--;
        while (!(date.toISOString().substring(0,10) in validDates)) {
          date.setDate(date.getDate() + 1);
          daysRemaining--;
        }
        updateGraph(currentTicker);
        prevDayAssets = cashAvailable + portfolioValue;
        updatePortfolioValue();
        document.getElementById("current_date").innerHTML = date.toLocaleDateString();
        document.getElementById("days_remaining").innerHTML = daysRemaining;
        document.getElementById("cash_available").innerHTML = Math.round(cashAvailable * 100) / 100;
        document.getElementById("portfolio_value").innerHTML = Math.round(portfolioValue * 100) / 100;
        document.getElementById("total_assets").innerHTML = Math.round(100 * (cashAvailable + portfolioValue)) / 100;
        var oneDayChange = cashAvailable + portfolioValue - prevDayAssets;
        var totalChange = cashAvailable + portfolioValue - 5000;
        document.getElementById("24hr_change_dollars").innerHTML = Math.round(oneDayChange * 100) / 100;
        document.getElementById("24hr_change_percent").innerHTML = Math.round(10000 * oneDayChange / prevDayAssets) / 100;
        document.getElementById("total_change_dollars").innerHTML = Math.round(totalChange * 100) / 100;
        document.getElementById("total_change_percent").innerHTML = Math.round(10000 * totalChange / 5000) / 100;
        // TODO: erase this when buy/sell implemented
        document.getElementById("num_shares").innerHTML = userStocks[currentTicker].shares;
        document.getElementById("shares_dollars").innerHTML = Math.round(userStocks[currentTicker].shares * getCurrentPrice(currentTicker) * 100) / 100;
      }

      function getCurrentPrice(ticker) {
        return userStocks[ticker].timeSeries[date.toISOString().substring(0,10)]['5. adjusted close'];
      }

      function confirmSale() {
        numShares = Number(document.getElementById("buy_sell_shares").value);
        document.getElementById("buy_sell_shares").value = "";
        if (!Number.isInteger(numShares) || numShares < 1) {
          console.error("invalid number of shares specified");
          return;
        }
        if (document.getElementById("buy").checked) {
          if (getCurrentPrice(currentTicker) * numShares <= cashAvailable) {
            cashAvailable -= getCurrentPrice(currentTicker) * numShares;
            userStocks[currentTicker].shares += numShares;
          }
        }
        else {
          if (numShares <= userStocks[currentTicker].shares) {
            cashAvailable += getCurrentPrice(currentTicker) * numShares;
            userStocks[currentTicker].shares -= numShares;
          }
        }
        updatePortfolioValue();
        document.getElementById("num_shares").innerHTML = userStocks[currentTicker].shares;
        document.getElementById("shares_dollars").innerHTML = Math.round(userStocks[currentTicker].shares * getCurrentPrice(currentTicker) * 100) / 100;
        document.getElementById("cash_available").innerHTML = Math.round(cashAvailable * 100) / 100;
        document.getElementById("portfolio_value").innerHTML = Math.round(portfolioValue * 100) / 100;
        document.getElementById("total_assets").innerHTML = Math.round(100 * (cashAvailable + portfolioValue)) / 100;
      }

      function updatePortfolioValue() {
        val = 0;
        for (var key in userStocks) {
          if (typeof userStocks[key].timeSeries[date.toISOString().substring(0,10)] !== 'undefined') {
            numShares = userStocks[key].shares;
            sharePrice = getCurrentPrice(key);
            val += numShares * sharePrice
          }
        }
        portfolioValue = val;
      }

      async function updateAll() {
        var ticker = document.getElementById("new_ticker").value.toUpperCase();
        document.getElementById("new_ticker").value = "";

        // TODO replace with better validation/trimming
        if (ticker.length == 0) {
          return;
        }
        if (ticker.charAt(0) == '$') {
          ticker = ticker.substring(1, ticker.length);
        }
        if (ticker.length == 0) {
          return;
        }

        if (await updateTicker(ticker)) {
          updateGraph(ticker);
        }
      }

      async function updateTicker(ticker) {
        console.log("updating ticker");

        // if ticker absent in local storage

        // TODO: abstract into another method
        if (!(ticker in userStocks)) {
          url = "https://www.alphavantage.co/query?function=OVERVIEW&symbol=" + ticker + "&apikey=" + apiKey;
          let name = await fetch(url)
            .then(response => response.json())
            .then(data => data.Name);

          if (typeof name !== 'undefined') {
            console.log("ticker " + ticker + " found, saving data from alphavantage");
            url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=" + ticker + "&outputsize=full&apikey=" + apiKey;
            let timeSeries = await fetch(url)
              .then(response => response.json())
              .then(data => data["Time Series (Daily)"]);
            userStocks[ticker] = {
              shares: 0,
              name: name,
              timeSeries: timeSeries
            }
            currentTicker = ticker;
            document.getElementById("current_ticker").innerHTML = "$" + ticker;
            document.getElementById("current_stock").innerHTML = name;
            document.getElementById("num_shares").innerHTML = 0;
            document.getElementById("shares_dollars").innerHTML = 0;
            return true;
          }
          else {
            console.error("ticker " + ticker +  " does not exist");
            return false;
          }
        }

        // if ticker present in local storage
        if (typeof userStocks[ticker].name !== 'undefined') {
          currentTicker = ticker;
          document.getElementById("current_ticker").innerHTML = "$" + ticker;
          document.getElementById("current_stock").innerHTML = userStocks[ticker].name;
          document.getElementById("num_shares").innerHTML = userStocks[ticker].shares;
          document.getElementById("shares_dollars").innerHTML = Math.round(userStocks[ticker].shares * getCurrentPrice(ticker) * 100) / 100;
          return true;
        }
        else {
          return false;
        }
      }

      async function updateGraph(ticker) {
        console.log("updating graph");
        if (!(ticker in userStocks)) {
          console.error("don't get here!");
        }
        else {
          console.log("ticker " + ticker + " found, getting data from storage");
        }
        jsonData = userStocks[ticker].timeSeries;

        var trace = {
          type: "scatter",
          mode: "lines",
          x: [],
          y: [],
          line: {color: 'lime'}
        }

        var data = [trace];

        for (var key in jsonData) {
            if (jsonData.hasOwnProperty(key)) {
                trace.x.push(key);
                trace.y.push(jsonData[key]['5. adjusted close']);
            }
        }

        // a week ago
        var date1 = new Date(date);
        date1.setDate(date1.getDate() - 7);

        min = 0;
        max = 0;
        first = 0;
        last = 0;

        for (var i = new Date(date1); i <= date; i.setDate(i.getDate() + 1)) {
          dateString = i.toISOString().substring(0,10);
          if (dateString in jsonData) {
            closePrice = jsonData[dateString]['5. adjusted close'];
            if (first == 0) {
              min = closePrice;
              max = closePrice;
              first = closePrice;
            }
            if (closePrice < min) {
              min = closePrice;
            }
            if (closePrice > max) {
              max = closePrice;
            }
            last = closePrice;
          }
        }

        if (first > last) {
          trace.line.color = 'red';
        }

        var layout = {
          title: '$' + ticker + ' Stock Price',
          paper_bgcolor: '#003',
          plot_bgcolor: '#003',
          font: {
            family: 'Roboto Mono, monospace',
            color: '#fff'
          },
          coloraxis: {
            colorbar: {
              tickcolor: '#fff',
              showticklabels: false
            }
          },
          titlefont: {
            size: 30
          },
          xaxis: {
            range: [date1, date],
            gridcolor: '#335'
          },
          yaxis: {
            range: [min, max],
            gridcolor: '#335'
          }
        };

        var config = {
          responsive: true
        }

        Plotly.newPlot('graphic', data, layout, config);
      }
    </script>
  </body>
</html>