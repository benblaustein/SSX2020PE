<!DOCTYPE html>
<html>
  <title>SSX2020PE™</title>
  <head>
    <link rel="stylesheet" href="main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

  <body>
    <div id="navbar">
      <h2>SSX2020PE™</h2>
      <div id="navmenu">
        <a href="">About</a>
        <span>|</span>
        <a href="">Account</a>
        <span>|</span>
        <a href="">Help</a>
        <span>|</span>
        <a href="">Logout</a>
      </div>
    </div>

    <div id="graphic">
    </div>

    <div id="menu">
      <h1 id="current_ticker">$AAPL</h1>
      <h4 id="current_stock">Apple Inc</h4>
      <hr style="border: 1.5px solid white">
      <div id="enter_ticker">Enter a new stock symbol: <input id="new_ticker"><button type="button" id="search_ticker" onclick="updateAll()">Search</button></div>
        <script>
          var input = document.getElementById("new_ticker");
          input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
              event.preventDefault();
              document.getElementById("search_ticker").click();
            }
          });
        </script>
      <hr style="border: 1.5px solid white">
      <p id="current_holdings">Current holdings: <span id="num_shares">0</span> shares</p>
      <p id="shares_value">Total value of shares: $<span id="shares_dollars">0.00</span></p>
        <form id="buy_sell">
          <input type="radio" id="buy" name="buy_or_sell" checked>
          <label for="buy">Buy</label>
          <input type="radio" id="sell" name="buy_or_sell">
          <label for="sell">Sell</label>
        </form>
        <input id="buy_sell_shares" type="number">
        <span> shares<button type="button" id="confirm_sale" onclick="confirmSale()">Confirm</button></span>
        <script>
          var input = document.getElementById("buy_sell_shares");
          input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
              event.preventDefault();
              document.getElementById("confirm_sale").click();
            }
          });
        </script>
      <hr style="border: 1.5px solid white">
    </div>

    <div id="holdings">
      <div id="stats_time">
        <p>Current date: <span id="current_date"></span></p>
        <p>Days remaining: <span id="days_remaining"></span></p>
        <p>24hr change: <span id="24hr_change_percent">0.00</span>%/$<span id="24hr_change_dollars">0.00</span></p>
        <p>Overall change: <span id="total_change_percent">0.00</span>%/$<span id="total_change_dollars">0.00</span></p>
        <button id="advance_date" type="button" onclick="advanceDate()">Advance day</button>
      </div>
      <div id="stats_cash">
        <p>Cash available: $<span id="cash_available">0.00</span></p>
        <p>Portfolio value: $<span id="portfolio_value">0.00</span></p>
        <p>Total assets: $<span id="total_assets">0.00</span></p>
      </div>
      <div id="stats_holdings">
        <table id="holdings_table">
          <thead>
            <tr>
              <th>Stock</th>
              <th>Shares</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <div id="notification_bar">
      <div id="notification_text">
        Date advanced
      </div>
    </div>

    <script>
      var notificationBar = document.getElementById('notification_bar');
      var animate;

      async function notify(text, type) {
        clearTimeout(animate);
        if (type == "log") {
          notificationBar.classList.remove("error");
          notificationBar.classList.add("log");
        }
        else {
          notificationBar.classList.remove("log");
          notificationBar.classList.add("error");
        }
        document.getElementById("notification_text").innerHTML = text;
        notificationBar.classList.add('fade');
        animate = await setTimeout(function(){notificationBar.classList.remove('fade')}, 3000);
      }

      const apiKey = "SK92GYM09TPNS82E";
      var daysRemaining = 365;
      var cashAvailable = 5000;
      var portfolioValue = 0;
      var currentTicker = "AAPL";
      var validDates;
      var userStocks = {};
      var date;

      initialLoad();

      async function initialLoad() {
        await getValidDates();
        date = new Date();
        date.setDate(date.getDate() - 366);
        while (!(date.toISOString().substring(0,10) in validDates)) {
          date.setDate(date.getDate() + 1);
        }
        if (await updateTicker("AAPL")) {
          updateGraph("AAPL");
        }
        document.getElementById("current_date").innerHTML = date.toLocaleDateString();
        document.getElementById("days_remaining").innerHTML = daysRemaining;
        document.getElementById("cash_available").innerHTML = cashAvailable.toFixed(2);
        document.getElementById("portfolio_value").innerHTML = portfolioValue.toFixed(2);
        document.getElementById("total_assets").innerHTML = (cashAvailable + portfolioValue).toFixed(2);
      }

      async function getValidDates() {
        const url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=AAPL&outputsize=full&apikey=" + apiKey;
        const dates = await fetch(url)
        .then(response => response.json())
        .then(data => data["Time Series (Daily)"]);
        validDates = dates;
        return;
      }

      function advanceDate() {
        date.setDate(date.getDate() + 1);
        daysRemaining--;
        while (!(date.toISOString().substring(0,10) in validDates)) {
          date.setDate(date.getDate() + 1);
          daysRemaining--;
        }
        updateGraph(currentTicker);
        prevDayAssets = cashAvailable + portfolioValue;
        updatePortfolioValue();
        document.getElementById("current_date").innerHTML = date.toLocaleDateString();
        document.getElementById("days_remaining").innerHTML = daysRemaining;
        document.getElementById("cash_available").innerHTML = cashAvailable.toFixed(2);
        document.getElementById("portfolio_value").innerHTML = portfolioValue.toFixed(2);
        document.getElementById("total_assets").innerHTML = (cashAvailable + portfolioValue).toFixed(2);
        var oneDayChange = cashAvailable + portfolioValue - prevDayAssets;
        var totalChange = cashAvailable + portfolioValue - 5000;
        document.getElementById("24hr_change_dollars").innerHTML = oneDayChange.toFixed(2);
        document.getElementById("24hr_change_percent").innerHTML = (100 * oneDayChange / prevDayAssets).toFixed(2);
        document.getElementById("total_change_dollars").innerHTML = totalChange.toFixed(2);
        document.getElementById("total_change_percent").innerHTML = (100 * totalChange / 5000).toFixed(2);
        // TODO: erase this when buy/sell implemented
        document.getElementById("num_shares").innerHTML = userStocks[currentTicker].shares;
        document.getElementById("shares_dollars").innerHTML = (userStocks[currentTicker].shares * getCurrentPrice(currentTicker)).toFixed(2);
      }

      function getCurrentPrice(ticker) {
        return Number(userStocks[ticker].timeSeries[date.toISOString().substring(0,10)]['5. adjusted close']);
      }

      function confirmSale() {
        numShares = Number(document.getElementById("buy_sell_shares").value);
        document.getElementById("buy_sell_shares").value = "";
        if (!Number.isInteger(numShares) || numShares < 1) {
          notify("Invalid number of shares specified", "error");
          return;
        }
        if (document.getElementById("buy").checked) {
          if (getCurrentPrice(currentTicker) * numShares <= cashAvailable) {
            cashAvailable -= getCurrentPrice(currentTicker) * numShares;
            userStocks[currentTicker].shares += numShares;
            notify("Purchased " + numShares + " shares of $" + currentTicker + " at $" + getCurrentPrice(currentTicker).toFixed(2), "log");
          }
          else {
            notify("Insufficient funds", "error");
          }
        }
        else {
          if (numShares <= userStocks[currentTicker].shares) {
            cashAvailable += getCurrentPrice(currentTicker) * numShares;
            userStocks[currentTicker].shares -= numShares;
            notify("Sold " + numShares + " shares of $" + currentTicker + " at $" + getCurrentPrice(currentTicker).toFixed(2), "log");
          }
          else {
            notify("Insufficient shares", "error");
          }
        }
        updatePortfolioValue();
        document.getElementById("num_shares").innerHTML = userStocks[currentTicker].shares;
        document.getElementById("shares_dollars").innerHTML = (userStocks[currentTicker].shares * getCurrentPrice(currentTicker)).toFixed(2);
        document.getElementById("cash_available").innerHTML = cashAvailable.toFixed(2);
        document.getElementById("portfolio_value").innerHTML = portfolioValue.toFixed(2);
        document.getElementById("total_assets").innerHTML = (cashAvailable + portfolioValue).toFixed(2);
        if (document.getElementById(currentTicker) == null && userStocks[currentTicker].shares != 0) {
          var table = document.getElementById("holdings_table");
          var row = table.insertRow(1);
          row.setAttribute("id", currentTicker);
          var cell1 = row.insertCell(0);
          cell1.innerHTML = currentTicker;
          var cell2 = row.insertCell(1);
          cell2.innerHTML = userStocks[currentTicker].shares;
        }
        else {
          if (userStocks[currentTicker].shares == 0) {
            var row = document.getElementById(currentTicker);
            row.parentNode.removeChild(row);
          }
          var cell = document.getElementById(currentTicker).getElementsByTagName("td")[1];
          cell.innerHTML = userStocks[currentTicker].shares;
        }
      }

      function updatePortfolioValue() {
        val = 0;
        for (var key in userStocks) {
          if (typeof userStocks[key].timeSeries[date.toISOString().substring(0,10)] !== 'undefined') {
            numShares = userStocks[key].shares;
            sharePrice = getCurrentPrice(key);
            val += numShares * sharePrice
          }
        }
        portfolioValue = val;
      }

      async function updateAll() {
        var ticker = document.getElementById("new_ticker").value.toUpperCase();
        document.getElementById("new_ticker").value = "";

        // TODO replace with better validation/trimming
        if (ticker.length == 0) {
          return;
        }
        if (ticker.charAt(0) == '$') {
          ticker = ticker.substring(1, ticker.length);
        }
        if (ticker.length == 0) {
          return;
        }

        if (await updateTicker(ticker)) {
          updateGraph(ticker);
        }
      }

      async function updateTicker(ticker) {

        // if ticker absent in local storage

        // TODO: abstract into another method
        if (!(ticker in userStocks)) {
          url = "https://www.alphavantage.co/query?function=OVERVIEW&symbol=" + ticker + "&apikey=" + apiKey;
          let name = await fetch(url)
            .then(response => response.json())
            .then(data => data.Name);

          if (typeof name !== 'undefined') {
            console.log("ticker " + ticker + " found, saving data from alphavantage");
            url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=" + ticker + "&outputsize=full&apikey=" + apiKey;
            let timeSeries = await fetch(url)
              .then(response => response.json())
              .then(data => data["Time Series (Daily)"]);
            userStocks[ticker] = {
              shares: 0,
              name: name,
              timeSeries: timeSeries
            }
            currentTicker = ticker;
            document.getElementById("current_ticker").innerHTML = "$" + ticker;
            document.getElementById("current_stock").innerHTML = name;
            document.getElementById("num_shares").innerHTML = 0;
            document.getElementById("shares_dollars").innerHTML = "0.00";
            return true;
          }
          else {
            notify("Unable to get data for $" + ticker, "error");
            return false;
          }
        }

        // if ticker present in local storage
        if (typeof userStocks[ticker].name !== 'undefined') {
          currentTicker = ticker;
          document.getElementById("current_ticker").innerHTML = "$" + ticker;
          document.getElementById("current_stock").innerHTML = userStocks[ticker].name;
          document.getElementById("num_shares").innerHTML = userStocks[ticker].shares;
          document.getElementById("shares_dollars").innerHTML = (userStocks[ticker].shares * getCurrentPrice(ticker)).toFixed(2);
          return true;
        }
        else {
          return false;
        }
      }

      async function updateGraph(ticker) {
        if (!(ticker in userStocks)) {
          console.error("ticker not found in storage");
        }
        jsonData = userStocks[ticker].timeSeries;

        var trace = {
          type: "scatter",
          mode: "lines",
          x: [],
          y: [],
          line: {color: 'lime'}
        }

        var data = [trace];

        for (var key in jsonData) {
          if (jsonData.hasOwnProperty(key)) {
            if (Date.parse(key) < date) {
              trace.x.push(key);
              trace.y.push(jsonData[key]['5. adjusted close']);
            }
          }
        }

        // a week ago
        var date1 = new Date(date);
        date1.setDate(date1.getDate() - 7);

        min = 0;
        max = 0;
        first = 0;
        last = 0;

        for (var i = new Date(date1); i <= date; i.setDate(i.getDate() + 1)) {
          dateString = i.toISOString().substring(0,10);
          console.log(dateString);
          if (dateString in jsonData) {
            closePrice = Number(jsonData[dateString]['5. adjusted close']);
            if (first == 0) {
              min = closePrice;
              max = closePrice;
              first = closePrice;
            }
            if (closePrice < min) {
              min = closePrice;
            }
            if (closePrice > max) {
              max = closePrice;
            }
            last = closePrice;
          }
        }

        if (first > last) {
          trace.line.color = 'red';
        }

        var layout = {
          title: '$' + ticker + ' Stock Price',
          paper_bgcolor: '#003',
          plot_bgcolor: '#003',
          font: {
            family: 'Roboto Mono, monospace',
            color: '#fff'
          },
          coloraxis: {
            colorbar: {
              tickcolor: '#fff',
              showticklabels: false
            }
          },
          titlefont: {
            size: 30
          },
          xaxis: {
            range: [date1, date],
            gridcolor: '#335'
          },
          yaxis: {
            range: [min, max],
            gridcolor: '#335'
          }
        };

        var config = {
          responsive: true
        }

        Plotly.newPlot('graphic', data, layout, config);
      }
    </script>
  </body>
</html>